<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Big Wobbly Book of Skateboarding</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;0,9..144,900;1,9..144,400&family=Nunito:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#E5DDD5; font-family:'Nunito',sans-serif; color:#3D2C24; padding:40px 20px; }
.book { max-width:900px; margin:0 auto; }

/* Spread: two pages side by side */
.spread {
  display:flex;
  justify-content:center;
  gap:0;
  margin:0 auto 12px;
  transition:transform 0.4s cubic-bezier(.25,.46,.45,.94);
}
.spread:hover { transform:translateY(-2px); }
.spread.single { justify-content:center; }

.spread-column {
  display:flex;
  flex-direction:column;
  align-items:center;
}
.spread-column.left-page .pg {
  border-radius:3px 0 0 3px;
  box-shadow: -2px 1px 4px rgba(0,0,0,.10), -3px 6px 16px rgba(0,0,0,.05);
}
.spread-column.right-page .pg {
  border-radius:0 3px 3px 0;
  box-shadow: 2px 1px 4px rgba(0,0,0,.10), 3px 6px 16px rgba(0,0,0,.05);
  border-left:1px solid #e0d6ca;
}
.spread:hover .spread-column.left-page .pg {
  box-shadow: -3px 3px 6px rgba(0,0,0,.12), -4px 10px 24px rgba(0,0,0,.07);
}
.spread:hover .spread-column.right-page .pg {
  box-shadow: 3px 3px 6px rgba(0,0,0,.12), 4px 10px 24px rgba(0,0,0,.07);
}
.spread.single .spread-column .pg {
  border-radius:3px;
  box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 4px 12px rgba(0,0,0,.06);
  border-left:none;
}

/* Spine shadow between pages */
.spine {
  width:6px;
  background:linear-gradient(to right,
    rgba(0,0,0,.08),
    rgba(0,0,0,.03) 30%,
    rgba(0,0,0,.01) 50%,
    rgba(0,0,0,.03) 70%,
    rgba(0,0,0,.08));
  align-self:stretch;
  position:relative;
}
.spine::after {
  content:'';
  position:absolute;
  top:0; bottom:0; left:50%;
  width:1px;
  background:rgba(0,0,0,.04);
}

/* Page */
.pg {
  width:380px; height:380px;
  background:#FAF4E5;
  padding:28px 30px;
  overflow:hidden;
  font-size:10.5px;
  line-height:1.55;
  transition:box-shadow 0.4s cubic-bezier(.25,.46,.45,.94);
}
.pg::-webkit-scrollbar { width:0; }

/* Paper texture overlay */
.pg::before {
  content:'';
  position:absolute;
  inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  background-size:180px 180px;
  pointer-events:none;
  z-index:2;
  border-radius:inherit;
}

/* Page edge vignette */
.pg::after {
  content:'';
  position:absolute;
  inset:0;
  box-shadow:inset 0 0 40px rgba(0,0,0,.04), inset 0 0 80px rgba(0,0,0,.02);
  pointer-events:none;
  z-index:2;
  border-radius:inherit;
}

/* Clouds */
.pg { position:relative; }
.pg .cloud {
  position:absolute;
  z-index:0;
  pointer-events:none;
  animation:cloud-drift 30s ease-in-out infinite alternate;
}
.pg .cloud:nth-child(2) { animation-delay:-10s; animation-duration:26s; }
.pg .cloud:nth-child(3) { animation-delay:-20s; animation-duration:34s; }

@keyframes cloud-drift {
  0% { transform:translateX(0); }
  100% { transform:translateX(12px); }
}

.pg > p, .pg > div, .pg > strong, .pg > em { position:relative; z-index:1; }


.pg p { margin-bottom:7px; }
.pg strong { font-weight:700; }
.pg em { font-style:italic; }
.pg .il { display:none; }
.pg .bullet { padding-left:14px; margin-bottom:4px; }
.pg .pn-note {
  background:#ECEAE7;
  border-radius:8px;
  padding:8px 12px;
  font-size:8.5px;
  color:#3D2C24;
  margin:10px 0;
  font-family:'Fraunces',serif;
  font-style:italic;
  line-height:1.5;
  text-align:center;
}


/* Drop cap on first paragraph of content pages */
.pg.has-dropcap > p:first-child::first-letter {
  font-family:'Fraunces',serif;
  font-weight:900;
  float:left;
  font-size:32px;
  line-height:0.8;
  padding-right:5px;
  padding-top:4px;
  color:#A0522D;
}

/* Poems */
.pg .poem {
  text-align:center;
  font-family:'Fraunces',serif;
  font-style:italic;
  font-size:10px;
  line-height:1.8;
  color:#6B5A8A;
  padding:12px 16px;
  margin:8px 0;
}
.pg.poem-page {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

/* Below page: number + illustration descriptions */
.page-footer {
  max-width:380px;
  margin:4px auto 0;
}
.il-note {
  background:#FFF5E0;
  border:1.5px dashed #F7D794;
  border-radius:5px;
  padding:6px 8px;
  font-size:8.5px;
  font-style:italic;
  color:#9A7B3A;
  line-height:1.4;
  margin-bottom:4px;
}

/* Decorative divider between spreads */
.spread-break {
  border:none;
  margin:32px auto;
  max-width:764px;
  height:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.spread-break::before,
.spread-break::after {
  content:'';
  flex:1;
  height:1px;
  background:linear-gradient(to var(--dir, right), transparent, #ccc5bc 20%, #ccc5bc 80%, transparent);
}
.spread-break::before { --dir:right; }
.spread-break::after { --dir:left; }
.spread-break-dot {
  width:5px; height:5px;
  border-radius:50%;
  background:#ccc5bc;
  flex-shrink:0;
}

/* Cover */
.pg.cover {
  padding:0;
  background-size:cover;
  background-position:center bottom;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}
.pg.cover::before, .pg.cover::after { display:none; }
.pg.cover .cover-text {
  padding:18px 20px 12px;
  text-align:center;
}
.pg.cover .cover-text h1 {
  font-family:'Fraunces',serif; font-weight:900; font-size:16px; line-height:1.15; margin-bottom:2px;
}
.pg.cover .cover-text .sub {
  font-family:'Fraunces',serif; font-style:italic; font-size:8.5px; color:#7A6B63;
}

/* Dedication */
.pg.dedication {
  display:flex; flex-direction:row; align-items:center; justify-content:flex-start;
  font-style:italic; font-size:11px; line-height:1.8; color:#7A6B63;
  padding:0; overflow:hidden;
  background-size:cover; background-position:center;
}
.pg.dedication::before, .pg.dedication::after { display:none; }
.pg.dedication .ded-text {
  width:50%; padding:24px 20px; text-align:center;
  display:flex; flex-direction:column; justify-content:center; height:100%;
}

/* Fade-in on scroll */
.spread {
  opacity:0;
  transform:translateY(8px);
  animation:page-appear 0.6s ease forwards;
}
@keyframes page-appear {
  to { opacity:1; transform:translateY(0); }
}

@media (max-width:820px) {
  .spread { flex-direction:column; align-items:center; gap:12px; }
  .spread-column.left-page .pg,
  .spread-column.right-page .pg {
    border-radius:3px;
    box-shadow: 0 1px 3px rgba(0,0,0,.12), 0 4px 12px rgba(0,0,0,.06);
    border-left:none;
  }
  .spine { display:none; }
  .spread-break { max-width:380px; }
  .spread:hover { transform:none; }
}
@media (max-width:500px) {
  .pg { width:min(360px, calc(100vw - 32px)); height:min(360px, calc(100vw - 32px)); padding:20px 22px; font-size:9.5px; }
  body { padding:20px 8px; }
  .page-footer { max-width:min(360px, calc(100vw - 32px)); }
  .spread-break { max-width:min(360px, calc(100vw - 32px)); }
}
</style>
</head>
<body>
<div class="book" id="book"></div>
<script src="sections.js"></script>
<script>
const DED_IMG = 'dedication.jpg';
const COVER_IMG = 'cover.jpg';

function buildPage(currentPage, section, els, perPage, p) {
  const pg = document.createElement('div');
  pg.className = 'pg';

  if (currentPage === 1) {
    pg.classList.add('cover');
    pg.style.backgroundImage = 'url(' + COVER_IMG + ')';
    pg.innerHTML = '<div class="cover-text"><h1>THE<br>BIG WOBBLY BOOK<br>OF<br>SKATEBOARDING</h1><div class="sub">A Real, Actual, Legitimate Guide<br>(With Only Moderate Amounts of Silliness)</div></div>';
  } else if (currentPage === 2) {
    pg.classList.add('dedication');
    pg.style.backgroundImage = 'url(' + DED_IMG + ')';
    pg.innerHTML = '<div class="ded-text">' + section.html + '</div>';
  } else {
    const slice = els.slice(p * perPage, (p + 1) * perPage);
    slice.forEach(el => pg.appendChild(el.cloneNode(true)));
  }

  if ([9,16,26].includes(currentPage)) pg.classList.add('poem-page');

  // Add drop cap to first page of each section (content pages only)
  if (currentPage > 2 && p === 0 && !pg.classList.contains('poem-page')) {
    const firstP = pg.querySelector('p');
    if (firstP && !firstP.querySelector('strong') && firstP.textContent.length > 20) {
      pg.classList.add('has-dropcap');
    }
  }

  // Add clouds to text-only pages
  if (currentPage > 2 && !pg.classList.contains('cover') && !pg.classList.contains('dedication')) {
    const seed = currentPage * 7;
    // 3 clouds, one in each vertical band (top, middle, bottom)
    const bands = [
      { yMin: 5, yMax: 80 },
      { yMin: 130, yMax: 210 },
      { yMin: 260, yMax: 320 }
    ];
    const picked = bands.map((band, i) => ({
      x: 10 + ((seed * (i+1) * 37) % 280),
      y: band.yMin + ((seed * (i+2) * 19) % (band.yMax - band.yMin))
    }));
    const cloudSvgs = [
      '<svg viewBox="0 0 120 50" xmlns="http://www.w3.org/2000/svg"><ellipse cx="35" cy="32" rx="28" ry="16" fill="FILLc"/><ellipse cx="60" cy="26" rx="26" ry="20" fill="FILLc"/><ellipse cx="85" cy="32" rx="24" ry="15" fill="FILLc"/></svg>',
      '<svg viewBox="0 0 100 45" xmlns="http://www.w3.org/2000/svg"><ellipse cx="28" cy="28" rx="22" ry="14" fill="FILLc"/><ellipse cx="50" cy="22" rx="24" ry="18" fill="FILLc"/><ellipse cx="72" cy="28" rx="20" ry="13" fill="FILLc"/></svg>',
      '<svg viewBox="0 0 140 50" xmlns="http://www.w3.org/2000/svg"><ellipse cx="35" cy="32" rx="25" ry="15" fill="FILLc"/><ellipse cx="65" cy="25" rx="28" ry="20" fill="FILLc"/><ellipse cx="95" cy="30" rx="30" ry="16" fill="FILLc"/><ellipse cx="115" cy="34" rx="18" ry="12" fill="FILLc"/></svg>'
    ];
    picked.forEach((pos, c) => {
      const cloud = document.createElement('div');
      cloud.className = 'cloud';
      const w = 55 + ((seed * (c+3) * 13) % 35);
      const op = 0.35 + ((seed * (c+1) * 7) % 20) / 100;
      const svgIdx = (seed + c) % cloudSvgs.length;
      cloud.innerHTML = cloudSvgs[svgIdx].replace(/FILLc/g, '#EACEBE');
      cloud.style.width = w + 'px';
      cloud.style.left = pos.x + 'px';
      cloud.style.top = pos.y + 'px';
      cloud.style.opacity = op;
      pg.appendChild(cloud);
    });
  }

  return pg;
}

function buildFooter(pg, currentPage) {
  const footer = document.createElement('div');
  footer.className = 'page-footer';
  const ils = pg.querySelectorAll('.il');
  ils.forEach(il => {
    const d = document.createElement('div');
    d.className = 'il-note';
    d.textContent = '\u{1F3A8} ' + il.textContent.trim();
    footer.appendChild(d);
  });
  return footer;
}

function render() {
  const book = document.getElementById('book');
  book.innerHTML = '';

  // First pass: collect all pages
  const allPages = [];
  let pageNum = 1;

  S.forEach(section => {
    const tmp = document.createElement('div');
    tmp.innerHTML = section.html;
    const els = [...tmp.children];
    const perPage = Math.ceil(els.length / section.est_pages);

    for (let p = 0; p < section.est_pages; p++) {
      const currentPage = pageNum + p;
      const pg = buildPage(currentPage, section, els, perPage, p);
      allPages.push({ pg, num: currentPage });
    }
    pageNum += section.est_pages;
  });

  // Second pass: arrange into spreads
  // Page 1 = cover (single), then pairs: 2-3, 4-5, 6-7...
  let i = 0;
  let firstSpread = true;

  while (i < allPages.length) {
    if (!firstSpread) {
      const divider = document.createElement('div');
      divider.className = 'spread-break';
      divider.innerHTML = '<span class="spread-break-dot"></span>';
      book.appendChild(divider);
    }
    firstSpread = false;

    if (i === 0) {
      // Cover page stands alone
      const spread = document.createElement('div');
      spread.className = 'spread single';
      const col = document.createElement('div');
      col.className = 'spread-column';
      col.appendChild(allPages[0].pg);
      col.appendChild(buildFooter(allPages[0].pg, allPages[0].num));
      spread.appendChild(col);
      book.appendChild(spread);
      i = 1;
    } else if (i + 1 < allPages.length) {
      // Two-page spread
      const spread = document.createElement('div');
      spread.className = 'spread';

      const leftCol = document.createElement('div');
      leftCol.className = 'spread-column left-page';
      leftCol.appendChild(allPages[i].pg);
      leftCol.appendChild(buildFooter(allPages[i].pg, allPages[i].num));

      const spine = document.createElement('div');
      spine.className = 'spine';

      const rightCol = document.createElement('div');
      rightCol.className = 'spread-column right-page';
      rightCol.appendChild(allPages[i+1].pg);
      rightCol.appendChild(buildFooter(allPages[i+1].pg, allPages[i+1].num));

      spread.appendChild(leftCol);
      spread.appendChild(spine);
      spread.appendChild(rightCol);
      book.appendChild(spread);
      i += 2;
    } else {
      // Last page alone (odd total)
      const spread = document.createElement('div');
      spread.className = 'spread single';
      const col = document.createElement('div');
      col.className = 'spread-column';
      col.appendChild(allPages[i].pg);
      col.appendChild(buildFooter(allPages[i].pg, allPages[i].num));
      spread.appendChild(col);
      book.appendChild(spread);
      i++;
    }
  }
}

render();

// Scroll-triggered fade-in for spreads
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.style.animationPlayState = 'running';
      observer.unobserve(entry.target);
    }
  });
}, { threshold: 0.15 });

document.querySelectorAll('.spread').forEach((spread, idx) => {
  spread.style.animationDelay = (idx * 0.08) + 's';
  spread.style.animationPlayState = 'paused';
  observer.observe(spread);
});

// Auto-fit: shrink text on pages where content overflows
function autoFitPages() {
  document.querySelectorAll('.pg').forEach(pg => {
    if (pg.classList.contains('cover') || pg.classList.contains('dedication')) return;
    
    const margin = 28; // desired margin around content
    const maxH = pg.clientHeight;
    
    let fontSize = 10.5;
    const minFontSize = 7;
    const step = 0.25;
    
    pg.style.fontSize = fontSize + 'px';
    
    while (pg.scrollHeight > maxH && fontSize > minFontSize) {
      fontSize -= step;
      pg.style.fontSize = fontSize + 'px';
      // Scale line-height and margins proportionally
      const lh = 1.35 + (fontSize - minFontSize) / (10.5 - minFontSize) * 0.2;
      pg.style.lineHeight = lh.toFixed(2);
      
      // Scale paragraph margins
      const pMargin = Math.max(2, Math.round((fontSize - minFontSize) / (10.5 - minFontSize) * 7));
      pg.querySelectorAll('p').forEach(p => p.style.marginBottom = pMargin + 'px');
      
      // Scale parent notes
      pg.querySelectorAll('.pn-note').forEach(n => {
        n.style.fontSize = Math.max(6.5, fontSize - 1.5) + 'px';
        n.style.padding = '4px 6px';
        n.style.margin = Math.max(3, pMargin) + 'px 0';
      });
    }
  });
}

// Run after initial render
setTimeout(autoFitPages, 100);
</script>
</body>
</html>